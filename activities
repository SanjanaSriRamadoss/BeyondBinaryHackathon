// ============================================================================
// PERSON 5: JOIN ACTIVITIES & NOTIFICATIONS - COMPLETE CODE
// ============================================================================

// ============================================================================
// DATABASE SCHEMA (SQL)
// ============================================================================

/*
-- Participants Table
CREATE TABLE participants (
  id SERIAL PRIMARY KEY,
  activity_id INTEGER REFERENCES activities(id) ON DELETE CASCADE,
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  joined_at TIMESTAMP DEFAULT NOW(),
  status VARCHAR(50) DEFAULT 'confirmed',
  UNIQUE(activity_id, user_id)
);

CREATE INDEX idx_participants_activity ON participants(activity_id);
CREATE INDEX idx_participants_user ON participants(user_id);

-- Notifications Table
CREATE TABLE notifications (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  type VARCHAR(50) NOT NULL,
  title VARCHAR(255) NOT NULL,
  message TEXT NOT NULL,
  activity_id INTEGER REFERENCES activities(id) ON DELETE CASCADE,
  is_read BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_notifications_user ON notifications(user_id, is_read);

-- Notification Preferences Table
CREATE TABLE notification_preferences (
  user_id INTEGER PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  email_enabled BOOLEAN DEFAULT TRUE,
  invite_notifications BOOLEAN DEFAULT TRUE,
  join_notifications BOOLEAN DEFAULT TRUE,
  update_notifications BOOLEAN DEFAULT TRUE,
  reminder_notifications BOOLEAN DEFAULT TRUE
);
*/

// ============================================================================
// BACKEND - DATABASE FUNCTIONS
// ============================================================================

// --- Participant Management Functions ---

// Add user as participant to activity
async function addParticipant(pool, activityId, userId) {
  const client = await pool.connect();
  try {
    await client.query('BEGIN');

    // Check if activity exists and has space
    const activityCheck = await client.query(
      'SELECT max_participants, (SELECT COUNT(*) FROM participants WHERE activity_id = $1) as current_count FROM activities WHERE id = $1',
      [activityId]
    );

    if (activityCheck.rows.length === 0) {
      throw new Error('Activity not found');
    }

    const { max_participants, current_count } = activityCheck.rows[0];
    if (current_count >= max_participants) {
      throw new Error('Activity is full');
    }

    // Add participant
    const result = await client.query(
      'INSERT INTO participants (activity_id, user_id) VALUES ($1, $2) RETURNING *',
      [activityId, userId]
    );

    await client.query('COMMIT');
    return result.rows[0];
  } catch (error) {
    await client.query('ROLLBACK');
    throw error;
  } finally {
    client.release();
  }
}

// Remove user from activity participants
async function removeParticipant(pool, activityId, userId) {
  const result = await pool.query(
    'DELETE FROM participants WHERE activity_id = $1 AND user_id = $2 RETURNING *',
    [activityId, userId]
  );
  return result.rows[0];
}

// Get all participants for an activity with user details
async function getParticipants(pool, activityId) {
  const result = await pool.query(
    `SELECT p.*, u.username, u.email, u.avatar_url 
     FROM participants p 
     JOIN users u ON p.user_id = u.id 
     WHERE p.activity_id = $1 
     ORDER BY p.joined_at ASC`,
    [activityId]
  );
  return result.rows;
}

// Get all activities a user has joined
async function getUserJoinedActivities(pool, userId) {
  const result = await pool.query(
    `SELECT a.*, p.joined_at 
     FROM activities a 
     JOIN participants p ON a.id = p.activity_id 
     WHERE p.user_id = $1 
     ORDER BY a.date_time ASC`,
    [userId]
  );
  return result.rows;
}

// Check if user is a participant
async function isParticipant(pool, activityId, userId) {
  const result = await pool.query(
    'SELECT * FROM participants WHERE activity_id = $1 AND user_id = $2',
    [activityId, userId]
  );
  return result.rows.length > 0;
}

// Get current participant count
async function getParticipantCount(pool, activityId) {
  const result = await pool.query(
    'SELECT COUNT(*) as count FROM participants WHERE activity_id = $1',
    [activityId]
  );
  return parseInt(result.rows[0].count);
}

// --- Notification Functions ---

// Create a new notification
async function createNotification(pool, userId, type, title, message, activityId = null) {
  const result = await pool.query(
    `INSERT INTO notifications (user_id, type, title, message, activity_id) 
     VALUES ($1, $2, $3, $4, $5) RETURNING *`,
    [userId, type, title, message, activityId]
  );
  return result.rows[0];
}

// Get user notifications with pagination
async function getUserNotifications(pool, userId, limit = 20, offset = 0) {
  const result = await pool.query(
    `SELECT n.*, a.title as activity_title 
     FROM notifications n 
     LEFT JOIN activities a ON n.activity_id = a.id 
     WHERE n.user_id = $1 
     ORDER BY n.created_at DESC 
     LIMIT $2 OFFSET $3`,
    [userId, limit, offset]
  );
  return result.rows;
}

// Mark notification as read
async function markAsRead(pool, notificationId) {
  const result = await pool.query(
    'UPDATE notifications SET is_read = TRUE WHERE id = $1 RETURNING *',
    [notificationId]
  );
  return result.rows[0];
}

// Mark all notifications as read for a user
async function markAllAsRead(pool, userId) {
  await pool.query(
    'UPDATE notifications SET is_read = TRUE WHERE user_id = $1',
    [userId]
  );
}

// Delete a notification
async function deleteNotification(pool, notificationId) {
  await pool.query('DELETE FROM notifications WHERE id = $1', [notificationId]);
}

// Get unread notification count
async function getUnreadCount(pool, userId) {
  const result = await pool.query(
    'SELECT COUNT(*) as count FROM notifications WHERE user_id = $1 AND is_read = FALSE',
    [userId]
  );
  return parseInt(result.rows[0].count);
}

// --- Email Functions ---

// Send email using email service (example with nodemailer)
async function sendEmail(transporter, to, subject, htmlContent) {
  const mailOptions = {
    from: process.env.EMAIL_FROM,
    to: to,
    subject: subject,
    html: htmlContent
  };
  
  return await transporter.sendMail(mailOptions);
}

// Send notification when someone joins activity
async function sendParticipantJoinedEmail(transporter, ownerEmail, participantName, activity) {
  const subject = `New participant joined: ${activity.title}`;
  const html = `
    <div style="font-family: Arial, sans-serif; color: #F5F7FA; background-color: #111827; padding: 20px;">
      <h2 style="color: #4F7DFF;">New Participant Joined!</h2>
      <p><strong>${participantName}</strong> has joined your activity.</p>
      <div style="background-color: #0F172A; padding: 15px; border-radius: 8px; margin: 20px 0;">
        <h3 style="color: #FF9F8E;">${activity.title}</h3>
        <p><strong>Date:</strong> ${new Date(activity.date_time).toLocaleDateString()}</p>
        <p><strong>Time:</strong> ${new Date(activity.date_time).toLocaleTimeString()}</p>
        <p><strong>Participants:</strong> ${activity.current_participants}/${activity.max_participants}</p>
      </div>
      <a href="${process.env.APP_URL}/activities/${activity.id}" 
         style="background-color: #4F7DFF; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;">
        View Activity
      </a>
    </div>
  `;
  
  return await sendEmail(transporter, ownerEmail, subject, html);
}

// ============================================================================
// BACKEND - API ROUTES (Express.js)
// ============================================================================

// --- Join/Leave Activity Routes ---

// POST /api/activities/:id/join - Join an activity
app.post('/api/activities/:id/join', authenticateToken, async (req, res) => {
  try {
    const activityId = req.params.id;
    const userId = req.user.id;

    // Check if user is activity owner
    const activity = await pool.query('SELECT * FROM activities WHERE id = $1', [activityId]);
    if (activity.rows.length === 0) {
      return res.status(404).json({ error: 'Activity not found' });
    }

    if (activity.rows[0].owner_id === userId) {
      return res.status(400).json({ error: 'Cannot join your own activity' });
    }

    // Check if already participant
    const alreadyJoined = await isParticipant(pool, activityId, userId);
    if (alreadyJoined) {
      return res.status(400).json({ error: 'Already joined this activity' });
    }

    // Add participant
    const participant = await addParticipant(pool, activityId, userId);

    // Create notification for activity owner
    const user = await pool.query('SELECT username FROM users WHERE id = $1', [userId]);
    await createNotification(
      pool,
      activity.rows[0].owner_id,
      'join',
      'New Participant',
      `${user.rows[0].username} joined your activity: ${activity.rows[0].title}`,
      activityId
    );

    // Send email if owner has email notifications enabled
    const prefs = await pool.query(
      'SELECT * FROM notification_preferences WHERE user_id = $1',
      [activity.rows[0].owner_id]
    );
    
    if (prefs.rows.length === 0 || (prefs.rows[0].email_enabled && prefs.rows[0].join_notifications)) {
      const owner = await pool.query('SELECT email FROM users WHERE id = $1', [activity.rows[0].owner_id]);
      // sendParticipantJoinedEmail(transporter, owner.rows[0].email, user.rows[0].username, activity.rows[0]);
    }

    res.json({ message: 'Successfully joined activity', participant });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// DELETE /api/activities/:id/leave - Leave an activity
app.delete('/api/activities/:id/leave', authenticateToken, async (req, res) => {
  try {
    const activityId = req.params.id;
    const userId = req.user.id;

    // Check if user is activity owner
    const activity = await pool.query('SELECT * FROM activities WHERE id = $1', [activityId]);
    if (activity.rows.length === 0) {
      return res.status(404).json({ error: 'Activity not found' });
    }

    if (activity.rows[0].owner_id === userId) {
      return res.status(400).json({ error: 'Cannot leave your own activity' });
    }

    // Remove participant
    const removed = await removeParticipant(pool, activityId, userId);
    if (!removed) {
      return res.status(400).json({ error: 'Not a participant of this activity' });
    }

    // Create notification for activity owner
    const user = await pool.query('SELECT username FROM users WHERE id = $1', [userId]);
    await createNotification(
      pool,
      activity.rows[0].owner_id,
      'leave',
      'Participant Left',
      `${user.rows[0].username} left your activity: ${activity.rows[0].title}`,
      activityId
    );

    res.json({ message: 'Successfully left activity' });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// GET /api/activities/:id/participants - Get activity participants
app.get('/api/activities/:id/participants', async (req, res) => {
  try {
    const participants = await getParticipants(pool, req.params.id);
    res.json(participants);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// GET /api/users/:id/joined-activities - Get user's joined activities
app.get('/api/users/:id/joined-activities', authenticateToken, async (req, res) => {
  try {
    const activities = await getUserJoinedActivities(pool, req.params.id);
    res.json(activities);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// --- Notification Routes ---

// GET /api/notifications - Get user notifications
app.get('/api/notifications', authenticateToken, async (req, res) => {
  try {
    const limit = parseInt(req.query.limit) || 20;
    const offset = parseInt(req.query.offset) || 0;
    const notifications = await getUserNotifications(pool, req.user.id, limit, offset);
    res.json(notifications);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// PATCH /api/notifications/:id/read - Mark notification as read
app.patch('/api/notifications/:id/read', authenticateToken, async (req, res) => {
  try {
    const notification = await markAsRead(pool, req.params.id);
    res.json(notification);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// DELETE /api/notifications/:id - Delete notification
app.delete('/api/notifications/:id', authenticateToken, async (req, res) => {
  try {
    await deleteNotification(pool, req.params.id);
    res.json({ message: 'Notification deleted' });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// PATCH /api/notifications/read-all - Mark all as read
app.patch('/api/notifications/read-all', authenticateToken, async (req, res) => {
  try {
    await markAllAsRead(pool, req.user.id);
    res.json({ message: 'All notifications marked as read' });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// GET /api/notifications/unread-count - Get unread count
app.get('/api/notifications/unread-count', authenticateToken, async (req, res) => {
  try {
    const count = await getUnreadCount(pool, req.user.id);
    res.json({ count });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// ============================================================================
// FRONTEND - REACT COMPONENTS
// ============================================================================

// --- Join/Leave Activity Button Component ---
function JoinLeaveButton({ activity, currentUser, onUpdate }) {
  const [loading, setLoading] = useState(false);
  const [isJoined, setIsJoined] = useState(false);

  useEffect(() => {
    checkIfJoined(); // Check if user has joined on component mount
  }, [activity.id]);

  // Check if current user is participant
  async function checkIfJoined() {
    const response = await fetch(`/api/activities/${activity.id}/participants`);
    const participants = await response.json();
    setIsJoined(participants.some(p => p.user_id === currentUser.id));
  }

  // Handle join activity
  async function handleJoin() {
    setLoading(true);
    try {
      const response = await fetch(`/api/activities/${activity.id}/join`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });

      if (response.ok) {
        setIsJoined(true);
        onUpdate && onUpdate();
      } else {
        const error = await response.json();
        alert(error.error);
      }
    } catch (error) {
      alert('Failed to join activity');
    }
    setLoading(false);
  }

  // Handle leave activity
  async function handleLeave() {
    if (!confirm('Are you sure you want to leave this activity?')) return;

    setLoading(true);
    try {
      const response = await fetch(`/api/activities/${activity.id}/leave`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });

      if (response.ok) {
        setIsJoined(false);
        onUpdate && onUpdate();
      } else {
        const error = await response.json();
        alert(error.error);
      }
    } catch (error) {
      alert('Failed to leave activity');
    }
    setLoading(false);
  }

  // Check if activity is full
  const isFull = activity.current_participants >= activity.max_participants;
  
  // Check if activity is past
  const isPast = new Date(activity.date_time) < new Date();
  
  // Check if user is owner
  const isOwner = activity.owner_id === currentUser.id;

  // Render appropriate button based on state
  if (isOwner) {
    return (
      <button 
        style={{
          backgroundColor: 'var(--accent-secondary)',
          color: 'var(--bg-primary)',
          padding: '10px 20px',
          border: 'none',
          borderRadius: '5px',
          cursor: 'pointer',
          fontWeight: 'bold'
        }}
        onClick={() => window.location.href = `/activities/${activity.id}/manage`}
      >
        Manage Activity
      </button>
    );
  }

  if (isPast) {
    return (
      <button 
        disabled
        style={{
          backgroundColor: 'var(--text-secondary)',
          color: 'var(--bg-primary)',
          padding: '10px 20px',
          border: 'none',
          borderRadius: '5px',
          cursor: 'not-allowed',
          opacity: 0.6
        }}
      >
        Activity Ended
      </button>
    );
  }

  if (isJoined) {
    return (
      <button 
        onClick={handleLeave}
        disabled={loading}
        style={{
          backgroundColor: 'transparent',
          color: 'var(--accent-primary)',
          padding: '10px 20px',
          border: '2px solid var(--accent-primary)',
          borderRadius: '5px',
          cursor: loading ? 'wait' : 'pointer',
          fontWeight: 'bold'
        }}
      >
        {loading ? 'Loading...' : 'Leave Activity'}
      </button>
    );
  }

  if (isFull) {
    return (
      <button 
        disabled
        style={{
          backgroundColor: 'var(--text-secondary)',
          color: 'var(--bg-primary)',
          padding: '10px 20px',
          border: 'none',
          borderRadius: '5px',
          cursor: 'not-allowed',
          opacity: 0.6
        }}
      >
        Activity Full ({activity.current_participants}/{activity.max_participants})
      </button>
    );
  }

  return (
    <button 
      onClick={handleJoin}
      disabled={loading}
      style={{
        backgroundColor: 'var(--accent-primary)',
        color: 'white',
        padding: '10px 20px',
        border: 'none',
        borderRadius: '5px',
        cursor: loading ? 'wait' : 'pointer',
        fontWeight: 'bold'
      }}
    >
      {loading ? 'Joining...' : `Join Activity (${activity.current_participants}/${activity.max_participants})`}
    </button>
  );
}

// --- Activity Detail Page Component ---
function ActivityDetailPage({ activityId, currentUser }) {
  const [activity, setActivity] = useState(null);
  const [participants, setParticipants] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadActivityDetails(); // Load activity and participants on mount
  }, [activityId]);

  // Fetch activity details and participants
  async function loadActivityDetails() {
    try {
      const [activityRes, participantsRes] = await Promise.all([
        fetch(`/api/activities/${activityId}`),
        fetch(`/api/activities/${activityId}/participants`)
      ]);

      const activityData = await activityRes.json();
      const participantsData = await participantsRes.json();

      setActivity(activityData);
      setParticipants(participantsData);
    } catch (error) {
      console.error('Failed to load activity details:', error);
    }
    setLoading(false);
  }

  if (loading) {
    return <div style={{ color: 'var(--text-primary)', padding: '20px' }}>Loading...</div>;
  }

  if (!activity) {
    return <div style={{ color: 'var(--text-primary)', padding: '20px' }}>Activity not found</div>;
  }

  return (
    <div style={{ 
      backgroundColor: 'var(--bg-primary)', 
      minHeight: '100vh',
      padding: '20px',
      color: 'var(--text-primary)'
    }}>
      {/* Activity Header */}
      <div style={{
        backgroundColor: 'var(--bg-card)',
        borderRadius: '10px',
        padding: '30px',
        marginBottom: '20px'
      }}>
        <h1 style={{ color: 'var(--accent-primary)', marginBottom: '10px' }}>
          {activity.title}
        </h1>
        <p style={{ color: 'var(--text-secondary)', fontSize: '16px' }}>
          {activity.description}
        </p>
        
        {/* Activity Details */}
        <div style={{ marginTop: '20px', display: 'grid', gap: '10px' }}>
          <div>
            <strong>Date:</strong> {new Date(activity.date_time).toLocaleDateString()}
          </div>
          <div>
            <strong>Time:</strong> {new Date(activity.date_time).toLocaleTimeString()}
          </div>
          <div>
            <strong>Location:</strong> {activity.location}
          </div>
          <div>
            <strong>Category:</strong> {activity.category}
          </div>
          <div>
            <strong>Difficulty:</strong> {activity.difficulty_level}
          </div>
          <div>
            <strong>Participants:</strong> {activity.current_participants}/{activity.max_participants}
          </div>
        </div>

        {/* Join/Leave Button */}
        <div style={{ marginTop: '20px' }}>
          <JoinLeaveButton 
            activity={activity} 
            currentUser={currentUser}
            onUpdate={loadActivityDetails}
          />
        </div>
      </div>

      {/* Participants Section */}
      <div style={{
        backgroundColor: 'var(--bg-card)',
        borderRadius: '10px',
        padding: '30px'
      }}>
        <h2 style={{ color: 'var(--accent-secondary)', marginBottom: '20px' }}>
          Participants ({participants.length})
        </h2>

        {participants.length === 0 ? (
          <p style={{ color: 'var(--text-secondary)' }}>No participants yet. Be the first to join!</p>
        ) : (
          <div style={{ display: 'grid', gap: '15px' }}>
            {participants.map(participant => (
              <div 
                key={participant.id}
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '15px',
                  padding: '15px',
                  backgroundColor: 'var(--bg-primary)',
                  borderRadius: '8px'
                }}
              >
                {/* Avatar */}
                <div style={{
                  width: '50px',
                  height: '50px',
                  borderRadius: '50%',
                  backgroundColor: 'var(--accent-primary)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: '20px',
                  fontWeight: 'bold'
                }}>
                  {participant.username[0].toUpperCase()}
                </div>

                {/* User Info */}
                <div style={{ flex: 1 }}>
                  <div style={{ fontWeight: 'bold', marginBottom: '5px' }}>
                    {participant.username}
                    {participant.user_id === activity.owner_id && (
                      <span style={{
                        marginLeft: '10px',
                        padding: '2px 8px',
                        backgroundColor: 'var(--accent-secondary)',
                        color: 'var(--bg-primary)',
                        borderRadius: '3px',
                        fontSize: '12px'
                      }}>
                        Organizer
                      </span>
                    )}
                  </div>
                  <div style={{ color: 'var(--text-secondary)', fontSize: '14px' }}>
                    Joined {new Date(participant.joined_at).toLocaleDateString()}
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

// --- Notification Bell Component ---
function NotificationBell({ currentUser }) {
  const [unreadCount, setUnreadCount] = useState(0);
  const [showDropdown, setShowDropdown] = useState(false);
  const [notifications, setNotifications] = useState([]);

  useEffect(() => {
    loadUnreadCount(); // Load unread count on mount
    loadNotifications(); // Load recent notifications
    
    const interval = setInterval(loadUnreadCount, 30000); // Poll every 30 seconds
    return () => clearInterval(interval);
  }, []);

  // Fetch unread notification count
  async function loadUnreadCount() {
    try {
      const response = await fetch('/api/notifications/unread-count', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });
      const data = await response.json();
      setUnreadCount(data.count);
    } catch (error) {
      console.error('Failed to load unread count:', error);
    }
  }

  // Fetch recent notifications
  async function loadNotifications() {
    try {
      const response = await fetch('/api/notifications?limit=5', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });
      const data = await response.json();
      setNotifications(data);
    } catch (error) {
      console.error('Failed to load notifications:', error);
    }
  }

  // Mark notification as read
  async function markRead(notificationId) {
    try {
      await fetch(`/api/notifications/${notificationId}/read`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });
      loadUnreadCount();
      loadNotifications();
    } catch (error) {
      console.error('Failed to mark as read:', error);
    }
  }

  // Format time ago (e.g., "2 hours ago")
  function timeAgo(date) {
    const seconds = Math.floor((new Date() - new Date(date)) / 1000);
    if (seconds < 60) return 'just now';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    const days = Math.floor(hours / 24);
    return `${days}d ago`;
  }

  return (
    <div style={{ position: 'relative' }}>
      {/* Bell Icon */}
      <button
        onClick={() => setShowDropdown(!showDropdown)}
        style={{
          position: 'relative',
          backgroundColor: 'transparent',
          border: 'none',
          cursor: 'pointer',
          fontSize: '24px',
          color: 'var(--text-primary)'
        }}
      >
        üîî
        {unreadCount > 0 && (
          <span style={{
            position: 'absolute',
            top: '-5px',
            right: '-5px',
            backgroundColor: 'var(--accent-secondary)',
            color: 'var(--bg-primary)',
            borderRadius: '50%',
            width: '20px',
            height: '20px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '12px',
            fontWeight: 'bold'
          }}>
            {unreadCount > 9 ? '9+' : unreadCount}
          </span>
        )}
      </button>

      {/* Notification Dropdown */}
      {showDropdown && (
        <div style={{
          position: 'absolute',
          top: '40px',
          right: '0',
          width: '350px',
          backgroundColor: 'var(--bg-card)',
          borderRadius: '10px',
          boxShadow: '0 4px 20px rgba(0,0,0,0.3)',
          zIndex: 1000,
          maxHeight: '400px',
          overflow: 'auto'
        }}>
          {/* Header */}
          <div style={{
            padding: '15px',
            borderBottom: '1px solid var(--bg-primary)',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <h3 style={{ margin: 0, color: 'var(--text-primary)' }}>Notifications</h3>
            <a 
              href="/notifications"
              style={{ 
                color: 'var(--accent-primary)', 
                textDecoration: 'none',
                fontSize: '14px'
              }}
            >
              View All
            </a>
          </div>

          {/* Notification List */}
          <div>
            {notifications.length === 0 ? (
              <div style={{ 
                padding: '30px', 
                textAlign: 'center', 
                color: 'var(--text-secondary)' 
              }}>
                No notifications
              </div>
            ) : (
              notifications.map(notification => (
                <div
                  key={notification.id}
                  onClick={() => {
                    markRead(notification.id);
                    window.location.href = `/activities/${notification.activity_id}`;
                  }}
                  style={{
                    padding: '15px',
                    borderBottom: '1px solid var(--bg-primary)',
                    cursor: 'pointer',
                    backgroundColor: notification.is_read ? 'transparent' : 'rgba(79, 125, 255, 0.1)',
                    transition: 'background-color 0.2s'
                  }}
                  onMouseEnter={(e) => e.target.style.backgroundColor = 'var(--bg-primary)'}
                  onMouseLeave={(e) => e.target.style.backgroundColor = notification.is_read ? 'transparent' : 'rgba(79, 125, 255, 0.1)'}
                >
                  {/* Notification Icon */}
                  <div style={{ display: 'flex', gap: '10px' }}>
                    <div style={{ fontSize: '20px' }}>
                      {notification.type === 'join' && 'üëã'}
                      {notification.type === 'leave' && 'üëã'}
                      {notification.type === 'update' && 'üì¢'}
                      {notification.type === 'reminder' && '‚è∞'}
                    </div>
                    <div style={{ flex: 1 }}>
                      <div style={{ 
                        fontWeight: notification.is_read ? 'normal' : 'bold',
                        color: 'var(--text-primary)',
                        marginBottom: '5px'
                      }}>
                        {notification.title}
                      </div>
                      <div style={{ 
                        color: 'var(--text-secondary)', 
                        fontSize: '14px',
                        marginBottom: '5px'
                      }}>
                        {notification.message}
                      </div>
                      <div style={{ 
                        color: 'var(--text-secondary)', 
                        fontSize: '12px' 
                      }}>
                        {timeAgo(notification.created_at)}
                      </div>
                    </div>
                  </div>
                </div>
              ))
            )}
          </div>
        </div>
      )}
    </div>
  );
}

// --- Notifications Page Component ---
function NotificationsPage({ currentUser }) {
  const [notifications, setNotifications] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadNotifications(); // Load all notifications on mount
  }, []);

  // Fetch all notifications
  async function loadNotifications() {
    try {
      const response = await fetch('/api/notifications?limit=50', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });
      const data = await response.json();
      setNotifications(data);
    } catch (error) {
      console.error('Failed to load notifications:', error);
    }
    setLoading(false);
  }

  // Mark all as read
  async function markAllRead() {
    try {
      await fetch('/api/notifications/read-all', {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });
      loadNotifications();
    } catch (error) {
      console.error('Failed to mark all as read:', error);
    }
  }

  // Delete notification
  async function deleteNotification(notificationId) {
    try {
      await fetch(`/api/notifications/${notificationId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });
      loadNotifications();
    } catch (error) {
      console.error('Failed to delete notification:', error);
    }
  }

  if (loading) {
    return <div style={{ color: 'var(--text-primary)', padding: '20px' }}>Loading...</div>;
  }

  return (
    <div style={{
      backgroundColor: 'var(--bg-primary)',
      minHeight: '100vh',
      padding: '20px'
    }}>
      {/* Header */}
      <div style={{
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: '20px'
      }}>
        <h1 style={{ color: 'var(--text-primary)' }}>Notifications</h1>
        <button
          onClick={markAllRead}
          style={{
            backgroundColor: 'var(--accent-primary)',
            color: 'white',
            border: 'none',
            padding: '10px 20px',
            borderRadius: '5px',
            cursor: 'pointer'
          }}
        >
          Mark All as Read
        </button>
      </div>

      {/* Notifications List */}
      <div style={{ backgroundColor: 'var(--bg-card)', borderRadius: '10px', padding: '20px' }}>
        {notifications.length === 0 ? (
          <p style={{ color: 'var(--text-secondary)', textAlign: 'center', padding: '30px' }}>
            No notifications
          </p>
        ) : (
          notifications.map(notification => (
            <div
              key={notification.id}
              style={{
                padding: '15px',
                borderBottom: '1px solid var(--bg-primary)',
                backgroundColor: notification.is_read ? 'transparent' : 'rgba(79, 125, 255, 0.1)',
                borderRadius: '5px',
                marginBottom: '10px'
              }}
            >
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                <div style={{ flex: 1 }}>
                  <h3 style={{ 
                    color: 'var(--text-primary)', 
                    marginBottom: '5px',
                    fontWeight: notification.is_read ? 'normal' : 'bold'
                  }}>
                    {notification.title}
                  </h3>
                  <p style={{ color: 'var(--text-secondary)', marginBottom: '10px' }}>
                    {notification.message}
                  </p>
                  <div style={{ display: 'flex', gap: '15px', fontSize: '14px' }}>
                    <span style={{ color: 'var(--text-secondary)' }}>
                      {new Date(notification.created_at).toLocaleDateString()} at {new Date(notification.created_at).toLocaleTimeString()}
                    </span>
                    {notification.activity_id && (
                      <a 
                        href={`/activities/${notification.activity_id}`}
                        style={{ color: 'var(--accent-primary)', textDecoration: 'none' }}
                      >
                        View Activity
                      </a>
                    )}
                  </div>
                </div>
                <button
                  onClick={() => deleteNotification(notification.id)}
                  style={{
                    backgroundColor: 'transparent',
                    border: 'none',
                    color: 'var(--text-secondary)',
                    cursor: 'pointer',
                    fontSize: '20px'
                  }}
                >
                  √ó
                </button>
              </div>
            </div>
          ))
        )}
      </div>
    </div>
  );
}

// ============================================================================
// EXAMPLE USAGE & INTEGRATION
// ============================================================================

/*
// In your main App component, add the NotificationBell to header:
function AppHeader({ currentUser }) {
  return (
    <header style={{ 
      backgroundColor: 'var(--bg-card)', 
      padding: '15px',
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center'
    }}>
      <h1 style={{ color: 'var(--accent-primary)' }}>Activity App</h1>
      <NotificationBell currentUser={currentUser} />
    </header>
  );
}

// In your activity card component:
function ActivityCard({ activity, currentUser }) {
  return (
    <div style={{ 
      backgroundColor: 'var(--bg-card)', 
      padding: '20px',
      borderRadius: '10px',
      marginBottom: '15px'
    }}>
      <h3 style={{ color: 'var(--text-primary)' }}>{activity.title}</h3>
      <p style={{ color: 'var(--text-secondary)' }}>{activity.description}</p>
      
      <div style={{ marginTop: '15px' }}>
        <JoinLeaveButton 
          activity={activity} 
          currentUser={currentUser}
          onUpdate={() => window.location.reload()}
        />
      </div>
    </div>
  );
}

// Route configuration:
<Route path="/activities/:id" element={<ActivityDetailPage activityId={params.id} currentUser={currentUser} />} />
<Route path="/notifications" element={<NotificationsPage currentUser={currentUser} />} />
*/